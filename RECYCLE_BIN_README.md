# 知识库回收站功能说明

## 功能概述

知识库回收站功能实现了完整的软删除机制，允许用户安全地删除知识库，并在需要时恢复它们。该功能包括：

- **软删除**：删除知识库时不会真正删除数据，而是标记为已删除
- **回收站管理**：查看已删除的知识库列表
- **恢复功能**：从回收站恢复已删除的知识库
- **永久删除**：彻底删除知识库及其相关数据

## 功能特性

### 1. 软删除机制
- 删除知识库时，设置 `is_deleted=True` 和 `delete_time=当前时间`
- 已删除的知识库不会在正常列表中显示
- 保留所有相关数据，便于恢复

### 2. 回收站界面
- 只有管理员可以看到回收站标签页
- 显示已删除知识库的详细信息
- 支持搜索和分页功能
- 显示删除时间（相对时间格式）

### 3. 恢复功能
- 一键恢复已删除的知识库
- 恢复后知识库重新出现在正常列表中
- 清除删除标记和时间

### 4. 永久删除
- 彻底删除知识库及其所有相关数据
- 包括文档、段落、问题、向量数据等
- 操作不可逆，请谨慎使用

## 技术实现

### 后端实现

#### 1. 数据模型修改
```python
class DataSet(AppModelMixin):
    # 软删除字段
    is_deleted = models.BooleanField(default=False, verbose_name="是否已删除")
    delete_time = models.DateTimeField(null=True, blank=True, verbose_name="删除时间")
```

#### 2. 查询过滤
- 所有知识库查询都会自动过滤已删除的知识库
- 回收站查询专门查询已删除的知识库
- 知识库详情查询会检查删除状态

#### 3. API接口
- `GET /dataset/recycle_bin/{page}/{page_size}` - 获取回收站列表
- `PUT /dataset/{id}/restore` - 恢复知识库
- `DELETE /dataset/{id}/permanently` - 永久删除知识库

### 前端实现

#### 1. 界面组件
- 回收站标签页（仅管理员可见）
- 知识库卡片显示删除状态
- 操作按钮（恢复/永久删除）

#### 2. API调用
- 使用真实的API接口替代假数据
- 支持搜索和分页
- 实时更新列表

## 使用方法

### 1. 删除知识库
1. 在知识库列表中找到要删除的知识库
2. 点击删除按钮
3. 确认删除操作
4. 知识库将被移动到回收站

### 2. 查看回收站
1. 以管理员身份登录
2. 在知识库页面点击"回收站"标签
3. 查看已删除的知识库列表
4. 可以使用搜索功能查找特定知识库

### 3. 恢复知识库
1. 在回收站中找到要恢复的知识库
2. 点击"恢复"按钮
3. 确认恢复操作
4. 知识库将重新出现在正常列表中

### 4. 永久删除
1. 在回收站中找到要永久删除的知识库
2. 点击"永久删除"按钮
3. 确认永久删除操作
4. 知识库及其所有数据将被彻底删除

## 注意事项

1. **权限控制**：只有管理员可以访问回收站功能
2. **数据安全**：软删除不会丢失数据，但会占用存储空间
3. **永久删除**：永久删除操作不可逆，请谨慎使用
4. **性能考虑**：大量已删除知识库可能影响查询性能

## 测试

运行测试脚本验证功能：
```bash
cd MaxKB
python test_recycle_bin.py
```

## 数据库迁移

如果数据库中没有软删除字段，需要运行迁移：
```bash
python manage.py makemigrations dataset
python manage.py migrate
```

## 配置说明

回收站功能无需额外配置，安装后即可使用。相关配置包括：

- 回收站列表分页大小：默认30条
- 删除时间显示格式：相对时间（如"2天前"）
- 权限控制：基于用户角色（ADMIN）

## 故障排除

### 常见问题

1. **回收站不显示**
   - 检查用户是否为管理员角色
   - 确认前端代码正确加载

2. **恢复失败**
   - 检查知识库是否真的被删除
   - 确认用户有相应权限

3. **永久删除失败**
   - 检查知识库是否在回收站中
   - 确认没有其他进程正在使用该知识库

### 日志查看

相关操作日志会记录在系统日志中，可以通过以下方式查看：
- 应用日志：`logs/app.log`
- 操作日志：通过管理界面的操作日志功能 