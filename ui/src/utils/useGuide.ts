import { postModelChat } from '@/api/model'


export default function useGuide() {
  const getGuideQuestions = async (modelId: string, mode: string, question: string, docments: string) => {
    const messages = [
      {
        role: 'user',
        content: `你的任务是根据用户提出的问题和提供的相关知识文档，当前模式是：${mode}，依据不同模式衍生出3个相关的引导式问题。模式及对应问题特性如下：
### AI问答
#### 1. 概念界定
若用户问题涉及概念询问，引导式问题需聚焦概念的不同语境侧重，询问关注领域、定义类型或与其他概念的关系等。例如，用户输入“什么是计算思维？”，引导式问答可以是：“‘计算思维’在不同语境下有不同侧重。为了精准解答，请告诉我：您关注的是K - 12教育还是高等教育/职业教育领域？您是需要一个理论定义，还是它在编程/数学课程中的具体表现？您是想了解它与‘数字素养’的区别与联系吗？”
#### 2. 研究问题聚焦
若用户问题是宽泛的兴趣点，引导式问题要对宏大概念进行维度细分，明确涉及的技术、学段或群体等。例如，用户提问“AI对教育公平的影响”，引导式问答可以是：“‘教育公平’是一个很宏大的概念，您具体关注哪个维度？是资源获取、学习过程，还是最终成果？‘AI也包含很多技术，您是指自适应学习系统、智能辅导，还是AI助教？您希望研究哪个特定学段或群体的学生？”
#### 3. 理论框架选择与构建
若用户需要为研究选择理论框架，引导式问题应提及相关理论，询问哪个更能解释现象及原因，或是否考虑整合理论构建独特框架。例如：“您已经了解过维果茨基的社会建构主义理论和布鲁纳的发现学习理论，哪一个更能解释您想探究的现象？为什么？或者，您是否考虑整合多个理论来构建一个更独特的分析框架？”

### AI写作
#### 1. 论文大纲生成
若用户想直接写一篇字数较多的学术论文，引导式问题告知先为其生成论文大纲，询问是否对大纲修改确认后再进入生成文档环节。
#### 2. 论文续写
若用户上传文档的结论部分只总结了研究结果需要续写，引导式问题分析文档缺失部分，给出针对性续写建议。例如，可询问是否结合当前研究中样本量较小的不足，提出扩大样本范围的具体建议。
#### 3. 申报书撰写
若用户申报相关课题，引导式问题可围绕选题结合政策调整方向、补充实际案例、完善研究方法、设定量化指标、说明成果应用场景、调整预算比例及关联性、细化技术路线图等方面进行询问。例如，用户申报“乡村教师专业发展”的相关课题，可询问：“您目前选题仅围绕培训模式展开，是否需要结合最新的 ‘县域教师发展支持体系’ 政策调整方向？另外，是否要补充该选题解决乡村教育实际问题的具体案例？申报书的研究方法只写了问卷调查法，为确保研究严谨性，是否考虑增加访谈法和案例研究法？若增加，是否需要我帮你梳理不同方法的实施步骤和数据整合方式？”
#### 4. 文字润色
若涉及论文不同部分润色，引导式问题针对不同部分存在的问题，如逻辑松散、口语化表达、语法错误、说服力不足等，提出调整段落顺序、替换表述、修正语法、增加案例等建议。例如，研究报告的引言部分逻辑较松散，可询问：“润色时是否需要调整段落顺序，按照 ‘研究背景 - 问题提出 - 研究意义’ 的逻辑重构？是否要强化段落间的衔接过渡？”

### AI翻译
#### 1. 面向不同读者
若用户要求翻译教育政策文件等，引导式问题询问目标读者、是否保持表述权威性、统一机构名称翻译、补充文化背景注释等。例如，用户要求翻译将一个中文的教育政策文件翻译成英文，可询问：“这份政策文件的目标读者是国外教育机构 / 学术同行 / 国际组织？是否需要保持政策表述的权威性（如‘义务教育’译为‘compulsory education’而非‘obligatory education’）？是否需要统一机构名称的翻译（如‘教育部’译为‘Ministry of Education’）？是否需要补充必要的文化背景注释（如‘双减’的内涵说明）？”
#### 2. 适用不同场景
若用户要求翻译学术会议演讲稿等，引导式问题询问演讲场景、是否兼顾学术严谨性与口语化表达等。例如，用户要求翻译将一个中文的学术会议演讲稿翻译成英文，可询问：“演讲场景是正式会议发言/海报展示/小组讨论？是否需要兼顾学术严谨性与口语化表达（如简化长句）？”

### AI摘要
#### 1. 提取摘要
若用户要求给论文写摘要，引导式问题询问希望摘要侧重的方面，如研究结论型、研究方法型、问题导向型等。例如：“您希望摘要侧重哪个方面？研究结论型摘要：重点突出核心发现。研究方法型摘要：重点介绍研究设计与方法创新。问题导向型摘要：重点强调研究要解决的问题和其重要性。”
#### 2. 优化摘要
若用户写的摘要信息不全或重点不突出，引导式问题要求用一句话回答研究的背景、方法、结果、结论。例如：“请用一句话回答：您的研究‘为什么做’（背景）？‘做了什么’（方法）？‘发现了什么’（结果）？‘意味着什么’（结论）？”
#### 3. 精简摘要
若模型已生成初始摘要，引导式问题询问是否需要控制摘要字数。

### AI综述
#### 1. 文献综述框架搭建
若用户要求写文献综述，引导式问题提供不同的脉络选择，如时间脉络、主题脉络等，询问用户喜欢的脉络以便填充内容。例如，用户输入“写一篇家校合作的文献综述。”，可询问：“一篇好的综述需要有清晰的逻辑脉络。我们可以按：时间脉络：梳理家校合作理念的演变。主题脉络：分为沟通机制、权责边界、共同育人等几个主题。请选择一种您喜欢的脉络，我们再来填充具体内容。”
#### 2. 文献综述的细化
若用户勾选文献要求分析研究趋势，引导式问题可从高频关键词演变、主要研究方法使用变化、未来可能研究方向预测等方面询问需求。
#### 3. 下一步工作建议
若用户生成了文献综述，引导式问题提供后续工作选项，如整理成学术用途综述稿、生成测量量表草案、定制培训大纲与课时安排等，询问用户需求。

以下是用户提出的问题：
<用户问题>
${question}
</用户问题>
以下是相关的知识文档：
<知识文档>
${docments}
</知识文档>
在衍生问题时，请确保这些问题与用户的问题和知识文档相关，并且具有一定的逻辑性和合理性。明确模式变量后，在<衍生问题>标签内写下3个相关的引导式问题，每个问题不超过20字，<衍生问题>标签内每行是一个问题，每个问题后需要有问号，避免使用模糊表述、特殊符号等可能干扰正则匹配的元素。
<衍生问题>
[在此写下3个方便正则匹配的相关引导式问题]
</衍生问题>
`,
      }
    ]
    const result = await postModelChat(modelId, { messages })
    const regex = /<衍生问题>\s*([\s\S]*?)\s*<\/衍生问题>/;
    const match = result.data.content.match(regex);
    if (match && match[1]) {
      const ret = match[1]
        .trim()
        .split('\n')
        .map((q: string) => q.trim())
      console.log(ret, '---引导式问题---', messages);
      return ret
    } else {
      throw new Error('未能提取引导式问题，请检查模型返回内容格式。');
    }
  }
  return { getGuideQuestions }
}